name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            os_name: 'macOS'
            targets: 'aarch64-apple-darwin,x86_64-apple-darwin'
          - platform: 'ubuntu-24.04'
            os_name: 'Linux'
            targets: 'x86_64-unknown-linux-gnu'
          - platform: 'windows-latest'
            os_name: 'Windows'
            targets: 'x86_64-pc-windows-msvc'

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@6d653acede28d24f02e3cd41383119e8b1b35921
        with:
          toolchain: stable
          targets: ${{ matrix.targets }}

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-24.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libxdo-dev \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev

      - name: Cache cargo registry
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: src-tauri/target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Install frontend dependencies
        run: npm install

      - name: Build the app (macOS Intel)
        if: matrix.platform == 'macos-latest'
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: npm run tauri build -- --target x86_64-apple-darwin

      - name: Build the app (macOS ARM)
        if: matrix.platform == 'macos-latest'
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: npm run tauri build -- --target aarch64-apple-darwin

      - name: Rename artifacts (macOS)
        if: matrix.platform == 'macos-latest'
        run: |
          node scripts/rename-artifacts.mjs darwin x86_64-apple-darwin
          node scripts/rename-artifacts.mjs darwin aarch64-apple-darwin

      - name: Generate updater JSON (macOS)
        if: matrix.platform == 'macos-latest'
        run: |
          node scripts/generate-updater-json.mjs darwin x86_64-apple-darwin
          node scripts/generate-updater-json.mjs darwin aarch64-apple-darwin

      - name: Build the app (Linux/Windows)
        if: matrix.platform != 'macos-latest'
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: npm run tauri build

      - name: Rename artifacts (Linux)
        if: matrix.platform == 'ubuntu-24.04'
        run: node scripts/rename-artifacts.mjs linux default

      - name: Generate updater JSON (Linux)
        if: matrix.platform == 'ubuntu-24.04'
        run: node scripts/generate-updater-json.mjs linux default

      - name: Rename artifacts (Windows)
        if: matrix.platform == 'windows-latest'
        run: node scripts/rename-artifacts.mjs windows default

      - name: Generate updater JSON (Windows)
        if: matrix.platform == 'windows-latest'
        run: node scripts/generate-updater-json.mjs windows default

      - name: Upload artifacts (macOS)
        if: matrix.platform == 'macos-latest'
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: macos-artifacts
          path: |
            src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
            src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg.tar.gz
            src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg.tar.gz.sig
            src-tauri/target/x86_64-apple-darwin/release/bundle/macos/*.app.tar.gz
            src-tauri/target/x86_64-apple-darwin/release/bundle/macos/*.app.tar.gz.sig
            src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg
            src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg.tar.gz
            src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg.tar.gz.sig
            src-tauri/target/aarch64-apple-darwin/release/bundle/macos/*.app.tar.gz
            src-tauri/target/aarch64-apple-darwin/release/bundle/macos/*.app.tar.gz.sig

      - name: Upload artifacts (Linux)
        if: matrix.platform == 'ubuntu-24.04'
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: linux-artifacts
          path: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/appimage/*.AppImage.sig

      - name: Upload artifacts (Windows)
        if: matrix.platform == 'windows-latest'
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: windows-artifacts
          path: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/msi/*.msi.sig
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/nsis/*.exe.sig

      - name: Upload latest.json (macOS Intel)
        if: matrix.platform == 'macos-latest'
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: latest-json-macos-x86_64
          path: src-tauri/target/x86_64-apple-darwin/release/bundle/macos/latest.json
          if-no-files-found: warn

      - name: Upload latest.json (macOS ARM)
        if: matrix.platform == 'macos-latest'
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: latest-json-macos-aarch64
          path: src-tauri/target/aarch64-apple-darwin/release/bundle/macos/latest.json
          if-no-files-found: warn

      - name: Upload latest.json (Linux)
        if: matrix.platform == 'ubuntu-24.04'
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: latest-json-linux
          path: src-tauri/target/release/bundle/appimage/latest.json
          if-no-files-found: warn

      - name: Upload latest.json (Windows)
        if: matrix.platform == 'windows-latest'
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: latest-json-windows
          path: src-tauri/target/release/bundle/nsis/latest.json
          if-no-files-found: warn

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: '24'

      - name: Download ExifTool binaries
        run: node scripts/download-exiftool.mjs

      - name: Get ExifTool version
        id: exiftool_version
        run: |
          chmod +x src-tauri/binaries/exiftool-x86_64-unknown-linux-gnu
          EXIFTOOL_VERSION=$(src-tauri/binaries/exiftool-x86_64-unknown-linux-gnu -ver)
          echo "version=$EXIFTOOL_VERSION" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          path: artifacts

      - name: Combine updater JSON files
        run: node scripts/combine-updater-json.mjs

      - name: Create Release
        uses: softprops/action-gh-release@5be0e66d93ac7ed76da52eca8bb058f665c3a5fe # v2.4.2
        with:
          files: |
            artifacts/macos-artifacts/**/*
            artifacts/linux-artifacts/**/*
            artifacts/windows-artifacts/**/*
            artifacts/latest.json
          body: |
            #### Bundled ExifTool version

            This release includes:

            **ExifTool v${{ steps.exiftool_version.outputs.version }}**
            https://exiftool.org
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
